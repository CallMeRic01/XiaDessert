<!-- Wappler include head-page="layouts/main" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="admin_order" appConnect="local" components="{dmxBootstrap5TableGenerator:{},dmxNotifications:{},dmxBootstrap5Modal:{},dmxFormRepeat:{},dmxDatastore:{},dmxFormatter:{},dmxBootstrap5Tooltips:{},dmxBootstrap5Popovers:{},dmxTyped:{},dmxBootstrap5Alert:{},dmxDatePicker:{},dmxGooglePlaces:{},dmxAutocomplete:{},dmxValidator:{}}" jquery_slim_35="cdn" moment_2="cdn" -->
<dmx-serverconnect id="conn_customerList" url="/api/admin/loyalty/customerList" dmx-param:cust_search="customerSearch.value" dmx-param:cust_num="serverconnectform1.customerSearch.value" dmx-param:cust_name="serverconnectform1.customerSearch.value"></dmx-serverconnect>
<dmx-serverconnect id="conn_totalSalesToday" url="/api/admin/sales/totalSalesToday"></dmx-serverconnect>
<dmx-serverconnect id="conn_stockUpdate" url="/api/admin/order/updateStock"></dmx-serverconnect>
<dmx-datastore id="cart" session="true"></dmx-datastore>
<dmx-datetime id="currentTime"></dmx-datetime>
<dmx-serverconnect id="conn_pullProduct" url="/api/admin/order/pullProduct"></dmx-serverconnect>
<dmx-serverconnect id="conn_createOrder" url="/api/admin/order/createOrder"></dmx-serverconnect>
<dmx-notifications id="notifies1"></dmx-notifications>
<dmx-variable id="insufficientStock" value="false"></dmx-variable>
<dmx-variable id="totalSalesToday" value="0"></dmx-variable>
<dmx-serverconnect id="conn_productsByDay" url="/api/admin/product/getProductsByDay" dmx-param:dayOfWeek="currentTime.datetime.formatDate('dddd')"></dmx-serverconnect>

<meta name="ac:route" content="/test_admin_order">
<%- await include('/partials/navbar', Object.assign({}, locals)) %>

<link rel="stylesheet" href="/css/style.css">

<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 product-list-scroll">
            <h3>Product List</h3>
            <div class="row border-rounded">
                <div class="col-6 col-md-4 fade-in" dmx-repeat:product_list="conn_productsByDay.data.query">
                    <div class="card small-card">
                        <img class="card-img-top" dmx-bind:src="'/uploads/proImage/'+pro_image">
                        <div class="card-body">
                            <h5 class="card-title text-center" dmx-text="pro_name"></h5>
                            <p class="card-text text-center">RM {{pro_price}}</p>
                            <div class="d-flex justify-content-between">
                                <button id="btn1" class="btn style3 text-bg-primary fw-bold" dmx-on:click="cart.upsert({pro_id: pro_id},{pro_name: pro_name, pro_id: pro_id, pro_price: pro_price, detOrd_quantity: 1, pro_stock: pro_stock})" dmx-hide="!pro_stat || pro_stock <= 0"><i class="fas fa-cart-plus"></i></button>
                                <p>Quantity: {{cart.data.where('pro_id', pro_id).values('detOrd_quantity')[0]}}</p>
                                <button id="btn2" class="btn style3 text-bg-primary fw-bold" dmx-bind:disabled="!pro_stat || pro_stock <= 0" dmx-show="!pro_stat || pro_stock <= 0">Unavailable</button>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button id="decrease1" class="btn btn-sm" dmx-on:click="cart.update({pro_id: pro_id},{detOrd_quantity: (cart.data.where('pro_id', pro_id).values('detOrd_quantity')[0] - 1)})" dmx-bind:disabled="cart.data.where('pro_id', pro_id).values('detOrd_quantity')[0] == 1"><i class="fas fa-minus"></i></button>
                                <button id="increase1" class="btn btn-sm" dmx-on:click="cart.update({pro_id: pro_id},{detOrd_quantity: (cart.data.where('pro_id', pro_id).values('detOrd_quantity')[0] + 1)})"><i class="fas fa-plus"></i></button>
                                <button id="remove1" class="btn btn-sm" dmx-on:click="cart.delete({pro_id: pro_id})"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-6">
            <h3 class="mt-3 visually-hidden">Cart</h3>
            <form method="post" action="/api/admin/order/createOrder" dmx-on:success="notifies1.success('Order added successfully');serverconnectform1.reset();cart.clear();conn_pullProduct.load({})" dmx-on:error="notifies1.danger('Failed to submit order')" is="dmx-serverconnect-form" id="serverconnectform1">
                <div class="row">
                    <div class="col-md-6 visually-hidden">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Product name</th>
                                        <th>Price (RM)</th>
                                        <th>Quantity</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody is="dmx-repeat" dmx-generator="bs5table" dmx-bind:repeat="cart.data" id="tableRepeat1" dmx-class:slide-in="cart.data.hasItems()">
                                    <tr>
                                        <td dmx-text="pro_name"></td>
                                        <td dmx-text="pro_price"></td>
                                        <td>
                                            <input id="text1" name="pro_id[]" type="hidden" class="form-control" dmx-bind:value="pro_id">
                                            <input id="text2" name="detOrd_quantity[]" type="hidden" class="form-control" dmx-bind:value="detOrd_quantity">
                                            <span dmx-text="detOrd_quantity"></span>
                                            <input id="text3" name="pro_stock[]" type="hidden" class="form-control" dmx-bind:value="pro_stock">
                                            <dmx-variable id="insufficientStockCheck" dmx-bind:value="cart.data.values().filter(q => q.detOrd_quantity > q.pro_stock).length > 0"></dmx-variable>
                                        </td>
                                        <td>
                                            <button id="decrease" class="btn btn-sm" dmx-on:click="cart.update({$id: $id},{detOrd_quantity: (detOrd_quantity - 1)})" dmx-bind:disabled="detOrd_quantity == 1"><i class="fas fa-minus"></i></button>
                                            <button id="increase" class="btn btn-sm" dmx-on:click="cart.update({$id: $id},{detOrd_quantity: (detOrd_quantity + 1)})"><i class="fas fa-plus"></i></button>
                                            <button id="remove" class="btn btn-sm" dmx-on:click="cart.delete({$id: $id})"><i class="fas fa-trash-alt"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-danger" dmx-show="cart.data.count() == 0 || (paymentMethod.value == 'Cash' && (order_amountPaid.value - ((cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) + takeawayFee.value)).round(2) < 0)">
                            <p dmx-show="cart.data.count() == 0">The cart is empty. Please add products to the cart.</p>
                            <p dmx-show="paymentMethod.value == 'Cash' && (order_amountPaid.value - ((cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) + takeawayFee.value)).round(2) < 0)">Insufficient funds for cash payment.</p>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="divider"></div>
                        <div class="row">
                            <div class="col">
                                <h6>Customer List</h6>
                                <input id="customerSearch" type="search" class="form-control mb-2" placeholder="Type to search...">
                                <input id="custID" name="cust_id" type="hidden" class="form-control" dmx-bind:value="CustomerSelect.value">
                                <select id="CustomerSelect" class="form-select" dmx-bind:options="conn_customerList.data.query" optiontext="cust_name + ' (' + cust_num + ')'" optionvalue="cust_id" name="selected_customerID">
                                    <option value="">Select a Customer</option>
                                </select>
                            </div>
                            <div class="col-2">
                                <button id="AddCust" class="btn text-bg-primary" dmx-on:click="CustomerReg.show()"><i class="fas fa-user-plus"></i></button>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <input type="hidden" id="totalAmount" name="ord_totalAmount" dmx-bind:value="(cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) + takeawayFee.value">
                        <input type="hidden" id="orderDateTime" name="ord_date" dmx-bind:value="currentTime.datetime">
                        <input type="hidden" id="orderDateTime1" name="detOrd_date" dmx-bind:value="currentTime.datetime">
                        <input type="hidden" id="changeAmount" name="ord_changeAmount" dmx-bind:value="paymentMethod.value == 'Cash' ? (order_amountPaid.value - ((cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) + takeawayFee.value)).round(2) : 0">
                        <div>
                            <p>Total Amount: RM {{(cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100).round(2) + takeawayFee.value}}</p>
                        </div>
                        <div class="form-group">
                            <label for="order_discount">Discount (%): </label>
                            <input type="number" id="order_discount" class="form-control" dmx-bind:value="0" name="ord_dis">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method: </label>
                            <select id="paymentMethod" name="ord_payMethod" class="form-select">
                                <option value="Cash">Cash</option>
                                <option value="TnG">TnG</option>
                                <option value="Grab">Grab</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="isTakeaway">Takeaway: </label>
                            <input type="hidden" id="takeawayFee">
                            <input type="checkbox" id="isTakeaway" name="ord_isTA" dmx-on:checked="isTakeaway.setValue(1)" dmx-on:changed="takeawayFee.setValue(isTakeaway.checked ? 0.20 : 0)">
                            <label for="isTakeaway">Yes</label>
                        </div>
                        <div class="form-group">
                            <label dmx-hide="paymentMethod.value == 'TnG' || paymentMethod.value == 'Grab'">Amount Paid: </label>
                            <input type="number" id="order_amountPaid" name="ord_paidCash" class="form-control" dmx-bind:value="(paymentMethod.value == 'Cash' ? value : 0)" dmx-hide="paymentMethod.value == 'TnG' || paymentMethod.value == 'Grab'">
                        </div>
                        <div class="form-group">
                            <label dmx-hide="paymentMethod.value == 'TnG' || paymentMethod.value == 'Grab'">Change: </label>
                            <span dmx-show="(order_amountPaid.value - (cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) - takeawayFee.value).round(2) &lt; 0 && paymentMethod.value == 'Cash'">Insufficient funds</span>
                            <span dmx-show="(order_amountPaid.value - (cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) - takeawayFee.value).round(2) >= 0">{{(order_amountPaid.value - (cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) - takeawayFee.value).round(2)}}</span>
                        </div>
                        <button class="btn btn-success mt-3" type="submit" dmx-bind:disabled="cart.data.count() == 0 || insufficientStock.value || (paymentMethod.value == 'Cash' && (order_amountPaid.value - ((cart.data.sum(`(pro_price * detOrd_quantity)`)).round(2) * (1 - order_discount.value / 100) + takeawayFee.value)).round(2) < 0)">Submit Order</button>
                        <button id="btn3" class="btn mt-3 btn-outline-warning" dmx-on:click="ClosingModal.show();conn_totalSalesToday.load({})">Closing</button>
                        <div class="alert alert-danger mt-3" dmx-show="tableRepeat1[0].detOrd_quantity > tableRepeat1[0].pro_stock" id="InsufficientStock">Insufficient stock for one or more products in the cart.</div>
                    </div>
                    <div class="col-md-12 text-center mt-3">
                        <h3>{{currentTime.datetime.formatDate('dd-MM-yyyy | HH:mm:ss')}}</h3>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row border-rounded">
        <div class="modal" id="CustomerReg" is="dmx-bs5-modal" tabindex="-1">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Customer Information</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="CustReg" method="post" is="dmx-serverconnect-form" dmx-on:success="notifies1.success('Registered Successfully'); CustReg.reset(); CustomerReg.hide()" action="/api/admin/loyalty/customerReg">
                            <div class="row">
                                <div class="col">
                                    <p>Customer Name:</p>
                                    <input id="customer_name" name="cust_name" type="text" class="form-control" required="">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <p>Customer Email:</p>
                                    <input id="customer_email" name="cust_email" type="email" class="form-control" required="" data-rule-email="">
                                </div>
                                <div class="col">
                                    <p>Customer Number:</p>
                                    <input id="customer_number" name="cust_num" class="form-control" required="">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <p>Customer Date of Birth:&nbsp;</p>
                                    <input id="customerDOB" name="cust_dob" is="dmx-date-picker" format="MM-DD-YYYY" required="">
                                </div>
                            </div>
                            <button id="btn5" class="btn btn-outline-primary mt-3" dmx-on:click="" type="submit">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="ClosingModal" is="dmx-bs5-modal" tabindex="-1">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Closing</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="closingForm" method="post" action="/api/admin/order/openClose" is="dmx-serverconnect-form" dmx-on:success="notifies1.success('Closing data saved successfully'); ClosingModal.hide();" dmx-on:error="notifies1.danger('Failed to save closing data')">
                            <div class="mb-3">
                                <div class="row">
                                    <div class="col">
                                        <p>Total Sales Today: {{conn_totalSalesToday.data.query[0].total_sales}}</p>
                                        <label for="openingCash" class="form-label">Opening Cash</label>
                                        <input type="number" class="form-control" id="openingCash" name="rep_opening" required="">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="expenses" class="form-label">Expenses</label>
                                <input type="number" class="form-control" id="expenses" name="rep_expenses">
                            </div>
                            <div class="mb-3">
                                <label for="remarks" class="form-label">Remarks</label>
                                <textarea class="form-control" id="remarks" name="rep_remarks"></textarea>
                                <input id="text4" name="rep_date" type="hidden" class="form-control" dmx-bind:value="currentTime.datetime.formatDate('yyyy-MM-dd')">
                                <input id="text5" name="totalSales" class="form-control" dmx-bind:value="conn_totalSalesToday.data.query[0].total_sales" type="hidden">
                            </div>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>